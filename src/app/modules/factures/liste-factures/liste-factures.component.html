<div
  class="bg-[#fff] shadow-[0px_3px_30px_#00000029] rounded-[20px] ml-6 mr-6 p-6">
  <div class="grid grid-cols-2 gap-2">
    <div>
      <div class="flex col-start-1 col-end-3">
        <mat-icon class="pt-1">assignment</mat-icon>
        <h2 class="text-[#0C8040] font-semibold pl-2">
          Liste des factures <span class="text-black">“{{type}}”</span>
        </h2>
      </div>
    </div>
    <div class="flex justify-end">
      <div class="flex justify-end cursor-pointer pr-4" (click)="historiquefactures()" *ngIf="permissionService.hasPermission('Facturation', 'Liste des factures', 'R')">
        <mat-icon class="pt-1">update</mat-icon>
        <h2 class="text-[#000] font-semibold pl-2">Historique</h2>
      </div>
      <div class="flex cursor-pointer pr-4" (click)="exportFactures()" *ngIf="permissionService.hasPermission('Facturation', 'Liste des factures', 'R')">
        <mat-icon class="pt-[5px]">cloud_download</mat-icon>
        <h2 class="text-[#636363] font-semibold pl-2">
          Exporter
        </h2>
      </div>
      <div
        class="flex justify-end cursor-pointer"
        (click)="generatefacture()" *ngIf="permissionService.hasPermission('Facturation', 'Liste des factures', 'C')">
        <mat-icon class="pt-1">add_circle</mat-icon>
        <h2 class="text-[#0C8040] font-semibold pl-2">Générer une facture</h2>
      </div>
    </div>
  </div>
  <div *ngIf="bills$ | async as factureState">

    <div class="bg-[#F7F7F7] rounded-2xl mt-5 mr-auto ml-auto p-3">
      <div class="flex justify-evenly mt-5">
        <div
          class="bg-white rounded-[50%] border-[#E8E8E8] border w-48 h-48 p-10">
          <p class="text-black font-bold text-center mt-5">
            Nbr des factures à générer
          </p>
          <p class="text-[#0C8040] font-bold text-center mt-5">{{factureState?.factures?.length}}</p>
        </div>
        <div class="w-14 flex items-center text-[#BABABA]">
          <mat-icon class="text-5xl">arrow_right_alt</mat-icon>
        </div>
        <div
          class="bg-white rounded-[50%] border-[#E8E8E8] border w-48 h-48 p-10">
          <p class="text-black font-bold text-center mt-5">
            Nbr des factures à générer
          </p>
          <div class="flex justify-center mt-5">
            <p class="text-[#0C8040] font-bold text-center pr-5">350</p>
            <div class="flex cursor-pointer" (click)="expnonfacture()" *ngIf="permissionService.hasPermission('Facturation', 'Liste des factures', 'R')">
              <mat-icon class="text-[19px] text-[#FD8282]">warning</mat-icon>
              <p class="text-[#FD8282] font-normal text-[14px]">(50)</p>
            </div>
          </div>
        </div>
        <div class="w-14 flex items-center text-[#BABABA]">
          <mat-icon class="text-5xl">arrow_right_alt</mat-icon>
        </div>
        <div
          class="bg-white rounded-[50%] border-[#E8E8E8] border w-48 h-48 p-10">
          <p class="text-black font-bold text-center mt-5">Factures éditées</p>
          <p class="text-[#0C8040] font-bold text-center mt-5">0</p>
        </div>
      </div>
    </div>
    <div class="grid mt-4">
      <app-shared-filter
        [inputs]="inputsFiler"
        [extraInputs]="extraInputsFilter"
        (filter)="filtrer($event)"
      ></app-shared-filter>
    </div>
    <div *ngIf="factureState?.factures?.length <= 0 && factureState?.dataState =='Loading'" class="flex items-center justify-center mt-6">
      <mat-spinner [diameter]="80"></mat-spinner>
    </div>

    <div *ngIf="factureState?.factures?.length <= 0 && factureState?.dataState=='Success'" class="flex flex-col items-center">
      <h2>La liste des factures est vide</h2>
      <div
        class="flex cursor-pointer"
        (click)="generatefacture()" *ngIf="permissionService.hasPermission('Facturation', 'Liste des factures', 'C')">
        <mat-icon class="pt-1">add_circle</mat-icon>
        <h2 class="text-[#0C8040] font-semibold pl-2">Générer une facture</h2>
      </div>
    </div>

    <div *ngIf="factureState?.factures?.length>0">
      <div class="mt-5 overflow-auto">
        <div
          class="flex flex-row justify-between pl-3 pr-3 bg-white mb-5 shadow-[0px_3px_20px_#00000029] rounded-[18px] h-[115px] items-center "
          *ngFor="let facture of bills" style="min-width: max-content;">
          <div class="width-content">
            <div class="flex items-center" *ngIf="facture?.type == '_SPECIAL'" >
              <span class="font-bold text-green-600">
                Facture spéciale
              </span>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">assignment</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">N° de fac :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.reference) ? facture.reference : '---'}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">person</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Client :</p>
                <p class="text-[12px] text-[#000000]">{{ (facture?.customer?.name) ? (facture.customer.name  | truncate: [15, "..."]) : '---'}}</p>
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">date_range</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Date de fac :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.facture_date) ? (facture.facture_date  | date: 'dd/MM/yy') : '---'}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">date_range</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">
                  Date d’échéance :
                </p>
                <p class="text-[12px] text-[#000000]">{{(facture?.echeance_date) ? (facture.echeance_date  | date: 'dd/MM/yy') : '---'}}</p>
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">date_range</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Période du :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.start_date) ? (facture.start_date  | date: 'dd/MM/yy') : '---'}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">date_range</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Au :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.end_date) ? (facture.end_date  | date: 'dd/MM/yy') : '---'}}</p>
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">person</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Recouvreur :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.recouvreur?.reference) ? facture.recouvreur.reference : '---'}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">money</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Montant HT :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.montant_ht) ? (facture?.montant_ht | number) : 0}}</p>
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">attach_money</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">
                  Taux de remise :
                </p>
                <p class="text-[12px] text-[#000000]">{{(facture?.remise && facture?.remise?.nature != 'Fix') ? (facture?.remise?.taux | number) : '---'}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">attach_money</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Remise :</p>
                <p class="text-[12px] text-[#000000]">{{ (facture?.remise_montant | number) || 0}}</p>
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">local_atm</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">TVA 14% (DH) :</p>
                <p class="text-[12px] text-[#000000]" *ngIf="facture?.type != '_SPECIAL'">{{(facture?.montant_transport_tva) ? (facture.montant_transport_tva | number) : 0}}</p>
                <p class="text-[12px] text-[#000000]"  *ngIf="facture?.type == '_SPECIAL'" >{{(facture?.montant_ht) ? (facture.montant_ht | number) : 0}}</p>

              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">local_atm</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">TVA 20% (DH) :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.montant_service_tva) ? (facture.montant_service_tva | number) : 0}}</p>
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">money_off</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Montant avoir :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.montant_avoir) ? (facture.montant_avoir | number) : 0}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">date_range</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Montant TTC :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.montant_recalcule) ? (facture?.montant_recalcule | number) : ((facture?.montant_ttc) ? (facture?.montant_ttc | number) : 0)}}</p>
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">insert_comment</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">
                  Type règlement :
                </p>
                <p class="text-[12px] text-[#000000]">{{(facture?.paiements) ? facture.paiements[facture.paiements.length - 1].mode_paiement.designation : '---'}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">money</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Total payé :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.total_paye) ? (facture.total_paye | number) : 0}}</p>
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">money</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Solde à payer :</p>

                <p class="text-[12px] text-[#000000]">{{(facture.total_montant | number) || 0}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">place</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">
                  Nb {{(facture?.nature=='Messagerie')? 'colis' : 'palettes'}} / Exp :
                </p>
                <p class="text-[12px] text-[#000000]">{{(facture?.count_colis) ? facture.count_colis  : 0}} / {{(facture?.count_expedition) ? facture.count_expedition : 0}}</p>
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">list_alt</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Poids total</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.poids) ? facture.poids : 0}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">location_on</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Zone</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.zone?.code) ? facture.zone.code : '---'}}</p>
              </div>
            </div>
          </div>
          <div class="flex items-center justify-center">
            <button class="font-semibold p-3" [ngClass]="(facture?.remise?.taux || facture.taux_remise || facture.remise_montant)?'bg-[#DDFFF4] text-[#1AD598]':'non-remis'">
              {{(facture?.remise?.taux || facture.taux_remise || facture.remise_montant)?'Remise':'Non remise'}}
            </button>
          </div>
          <mat-icon mat-button [matMenuTriggerFor]="menu" class="cursor-pointer">more_vert</mat-icon>
          <mat-menu #menu="matMenu">
            <button  mat-menu-item (click)="sualisationglobale(facture?.uuid, facture?.nature)" *ngIf="permissionService.hasPermission('Facturation', 'Liste des factures', 'R') && facture?.type != '_SPECIAL'">
              <mat-icon>remove_red_eye</mat-icon>
              Visualisation globale
            </button>
            <button  mat-menu-item (click)="getFactureDetail(facture?.uuid, facture?.nature)" *ngIf="permissionService.hasPermission('Facturation', 'Liste des factures', 'R') && facture?.type != '_SPECIAL'">
              <mat-icon>list</mat-icon>
              Visualisation détaillée
            </button>
            <button mat-menu-item (click)="fichefacture(facture)" *ngIf="permissionService.hasPermission('Facturation', 'Liste des factures', 'R')">
              <mat-icon>print</mat-icon>
              Imprimer
            </button>
            <button mat-menu-item (click)="addPiecejointe(facture?.uuid)" *ngIf="permissionService.hasPermission('Facturation', 'Liste des factures', 'U')">
              <mat-icon> attach_file</mat-icon>
              Ajouter une pièce jointe
            </button>
            <button mat-menu-item (click)="motiffacteur(facture?.uuid)" *ngIf="permissionService.hasPermission('Facturation', 'Liste des factures', 'U') ">
              <mat-icon> insert_comment</mat-icon>
              Motif
            </button>
            <ng-container *ngIf="permissionService.hasPermission('Facturation', 'Liste des factures', 'U')">
            <button mat-menu-item *ngIf="facture.paiement_status == 'not payed'" (click)="recalculerfacture(facture)"  >
              <mat-icon> format_align_justify</mat-icon>
                Recalculer
            </button>
            <button mat-menu-item *ngIf="permissionService.hasPermission('Facturation', 'Liste des factures', 'R') && type == 'Affrètement'" (click)="regenerateAffretementFacture(facture?.uuid)"  >
              <mat-icon> format_align_justify</mat-icon>
                modifier les demandes
            </button>
            <button mat-menu-item *ngIf="!facture?.is_annuler" (click)="cancelFacture(facture?.uuid)">
              <mat-icon>cancel</mat-icon>
                Annuler
            </button>
          </ng-container>
          </mat-menu>
        </div>
      </div>
      <div class="mt-10">
        <p-paginator [rows]="pagination?.pageSize" [totalRecords]="pagination?.totalItems" (onPageChange)="paginate($event)" [rowsPerPageOptions]="[10 , 25 , 50 , 100]">
        </p-paginator>
      </div>
    </div>
  </div>
</div>
