<div
  class="bg-[#fff] shadow-[0px_3px_30px_#00000029] rounded-[20px] ml-6 mr-6 p-6"
>
  <div class="grid grid-cols-1 gap-2">
    <div>
      <div class="flex col-start-1 col-end-3">
        <mat-icon class="pt-1">monetization_on</mat-icon>

        <h2 class="text-[#0C8040] font-semibold pl-2">Remises</h2>
      </div>
    </div>
  </div>


  <div *ngIf="bills$ | async as factureState">
    <div class="grid mt-4">
      <app-shared-filter
        [inputs]="inputsFiler"
        [extraInputs]="extraInputsFilter"
        (filter)="filtrer($event)"
      ></app-shared-filter>
    </div>

    <div *ngIf="factureState?.dataState =='Loading'" class="flex items-center justify-center mt-6">
      <mat-spinner [diameter]="80"></mat-spinner>
    </div>

    <div *ngIf="factures?.length <= 0 && factureState?.dataState == 'Success'" class="flex flex-col items-center">
      <h2>La liste des factures est vide</h2>
    </div>

    <div *ngIf="factures?.length>0 && factureState?.dataState == 'Success'">
      <div class="mt-5 overflow-auto">
        <div class="pl-3 pr-3 mb-5 ml-3 mr-3" *ngIf="permissionService.hasPermission('Facturation', 'Remise', 'U')">
          <mat-checkbox (change)="$event ? toggleAllRows() : null"
            [checked]="selection.hasValue() && isAllSelected()"
            [indeterminate]="selection.hasValue() && !isAllSelected()"
            [aria-label]="checkboxLabel()">
            <span class="text-[#0C8040] font-semibold pl-2">Sélectionner tout</span>
          </mat-checkbox>
        </div>
        <div
          class="flex flex-row justify-between pl-3 pr-3 bg-white mb-5 mr-3 ml-3 shadow-[0px_3px_20px_#00000029] rounded-[18px] h-[115px] items-center "
          *ngFor="let facture of factures; let i = index" style="min-width: max-content;">
          <div class="pl-1 pr-2" *ngIf="permissionService.hasPermission('Facturation', 'Remise', 'U')">
            <mat-checkbox *ngIf="!facture?.remise && facture?.paiement_status == 'not payed' && (!facture?.montant_recalcule||(facture?.montant_recalcule && facture?.base_recalculation!='Saisi Manuelle'))" (click)="$event.stopPropagation()"
              (change)="$event ? selection.toggle(facture) : null"
              [checked]="selection.isSelected(facture)"
              [aria-label]="checkboxLabel(facture)"
              >
            </mat-checkbox>
            <mat-checkbox *ngIf="!(!facture?.remise && facture?.paiement_status == 'not payed' && (!facture?.montant_recalcule||(facture?.montant_recalcule && facture?.base_recalculation!='Saisi Manuelle')))" disabled="true"></mat-checkbox>
          </div>
          <mat-divider *ngIf="permissionService.hasPermission('Facturation', 'Remise', 'U')" [vertical]="true" class="mx-auto"></mat-divider>

          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">assignment</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">N° de fac :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.reference)?facture.reference:'---'}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">person</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Client :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.customer?.name )?(facture.customer.name  | truncate: [15, "..."]) :'---'}}</p>
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">date_range</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Date de fac :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.facture_date)?(facture.facture_date | date: 'dd/MM/yy'):'---'}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">date_range</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">
                  Date d’échéance :
                </p>
                <p class="text-[12px] text-[#000000]">{{(facture?.echeance_date)?(facture.echeance_date | date: 'dd/MM/yy'):'---'}}</p>
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">date_range</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Période du :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.start_date)?(facture.start_date | date: 'dd/MM/yy'):'---'}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">date_range</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Au :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.end_date)?(facture.end_date | date: 'dd/MM/yy'):'---'}}</p>
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">person</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Recouvreur :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.recouvreur?.reference)?facture.recouvreur?.reference:'---'}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">money</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Montant HT :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.montant_ht)?(facture.montant_ht | number):0}}</p>
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">attach_money</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">
                  Taux de remise :
                </p>
                <p class="text-[12px] text-[#000000]">{{(facture?.remise && facture?.remise?.nature != 'Fix') ? facture?.remise?.taux : '---'}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">attach_money</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Remise :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.remise_montant)?(facture.remise_montant| number):0 }}</p>
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">local_atm</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">TVA 14% (DH) :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.montant_transport_tva)?(facture.montant_transport_tva | number):0}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">local_atm</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">TVA 20% (DH) :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.montant_service_tva)?(facture.montant_service_tva | number):0}}</p>
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">money_off</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Montant avoir :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.montant_avoir)?(facture.montant_avoir | number):0}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">date_range</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Montant TTC :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.montant_recalcule) ? (facture?.montant_recalcule | number) : ((facture?.montant_ttc) ? (facture?.montant_ttc | number) : 0)}}</p>
                <!-- <p class="text-[12px] text-[#000000]">{{getMontantTTC(facture) | number}}</p> -->
                <!-- <p class="text-[12px] text-[#000000]">{{(facture?.montant_ttc | number) || 0}}</p> -->
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">insert_comment</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">
                  Type règlement :
                </p>
                <p class="text-[12px] text-[#000000]">{{(facture?.paiements) ? facture.paiements[facture.paiements.length - 1].mode_paiement.designation:'---'}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">money</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Total payé :</p>
                <p class="text-[12px] text-[#000000]">{{(facture?.total_paye)?(facture.total_paye | number):0}}</p>
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="width-content">
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">money</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">Solde à payer :</p>
                <!-- <p class="text-[12px] text-[#000000]">{{(facture?.total_montant)?(facture.total_montant | number):0}}</p> -->
                <!-- <p class="text-[12px] text-[#000000]">{{((facture?.total_montant)? facture.total_montant : getBalancePayable(facture)) | number}}</p> -->
                <p class="text-[12px] text-[#000000]">{{(facture?.total_montant | number) || 0}}</p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="icon ml-1">
                <mat-icon class="text-[19px] text-[#138742]">place</mat-icon>
              </div>
              <div class="pl-1">
                <p class="text-[#b5b5b5] text-[9px] font-medium">
                  Nb colis / Exp :
                </p>
                <p class="text-[12px] text-[#000000]">{{(facture?.count_colis)?facture.count_colis:0}} / {{(facture?.count_expedition)?facture.count_expedition:0}}</p>
              </div>
            </div>
          </div>
          <mat-divider [vertical]="true" class="mx-auto"></mat-divider>
          <div class="pl-1 pr-1">
            <div class="flex items-center justify-center">
              <span class="cursor-pointer pl-2">
                <mat-icon [matMenuTriggerFor]="menu" id="actions" *ngIf="(!facture?.remise && facture?.paiement_status == 'not payed' && (!facture?.montant_recalcule||(facture?.montant_recalcule && facture?.base_recalculation!='Saisi Manuelle')))||facture?.remise_id|| facture?.file?.detaillee_remise">
                  more_vert
                </mat-icon>
                <mat-icon aria-disabled="true" *ngIf="!((!facture?.remise && facture?.paiement_status == 'not payed' && (!facture?.montant_recalcule||(facture?.montant_recalcule && facture?.base_recalculation!='Saisi Manuelle')))||facture?.remise_id|| facture?.file?.detaillee_remise)">
                  more_vert
                </mat-icon>
              </span>
            </div>
            <mat-menu #menu="matMenu">
              <ng-container *ngIf="permissionService.hasPermission('Facturation', 'Remise', 'U')">
                <button mat-menu-item  *ngIf="!facture?.remise && facture?.paiement_status == 'not payed' && (!facture?.montant_recalcule||(facture?.montant_recalcule && facture?.base_recalculation!='Saisi Manuelle'))"
                (click)="onApplyDiscountOnMultiCustomers(facture)">
                Appliquer une remise
              </button>
              </ng-container>
              <ng-container *ngIf="permissionService.hasPermission('Facturation', 'Remise', 'R')">
              <button mat-menu-item  *ngIf="facture?.remise_id" (click)="reglementdialog(facture.remise?.workflow)">
                Voir Le workflow
              </button>
              </ng-container>
              <ng-container *ngIf="permissionService.hasPermission('Facturation', 'Remise', 'U')">
              <button mat-menu-item  *ngIf="facture?.file?.detaillee_remise" (click)="downloadDoc(facture.file.detaillee_remise)">
                Générer une facture sur remise
              </button>
              <ng-container *ngIf="facture.remise && facture.remise.workflow">
                <button mat-menu-item *ngIf="showValidateRemiseBtn(facture.remise) && facture.remise?.status != 'ACCEPTED' && facture.remise?.status != 'REJECTED'" (click)="validateRemise(facture.remise, 'CREATED')">Valider la remise</button>
                <button mat-menu-item *ngIf="showValidateRemiseBtn(facture.remise) && facture.remise?.status != 'ACCEPTED' && facture.remise?.status != 'REJECTED'" (click)="validateRemise(facture.remise, 'REJECTED')">Refuser la remise</button>
              </ng-container>
              </ng-container>
            </mat-menu>
          </div>

        </div>
      </div>
      <div class="mt-10">
        <p-paginator [rows]="pagination?.pageSize" [totalRecords]="pagination?.totalItems" (onPageChange)="paginate($event)" [rowsPerPageOptions]="[10 , 25 , 50 , 100]">
        </p-paginator>
      </div>
      <div class="grid grid-cols-2 gap-4 mt-16 mb-5"  *ngIf="selection.hasValue()">
        <div>
          <button *ngIf="permissionService.hasPermission('Facturation', 'Remise', 'U')"
            class="underline w-32 text-left mr-3 font-bold text-[18px] mt-3"
            (click)="onCancelDiscountOnMultiCustomers()"
            mat-dialog-close>
            Annuler
          </button>
        </div>
        <div class="text-right">
          <button (click)="onApplyDiscountOnMultiCustomers()" *ngIf="permissionService.hasPermission('Facturation', 'Remise', 'U')"
            class="bg-[#0C8040] text-[#fff] border-[#0C8040] rounded-[28px] shadow-[0px_3px_6px_#00000029] p-4 ml-9font-bold text-[18px]"
            type="submit">
            Remise sur plusieurs clients
          </button>
        </div>
      </div>
    </div>

  </div>

</div>
