<div class="dialog">
  <div
    class="grid grid-cols-3 gap-4 bg-[#E9E9E9] rounded-[12px_12px_0px_0px] p-4"
  >
    <h1 mat-dialog-title class="col-span-2">Détails Ticket</h1>
    <div class="text-right cursor-pointer" mat-button mat-dialog-close>
      <mat-icon>close</mat-icon>
    </div>
  </div>
  <mat-dialog-content>
    <div class="grid grid-cols-4 gap-4 reclamation-row">
      <div [formGroup]="taskForm" class="col-span-3 font-normal left-grid-border">
        <div>
          <div class="flex flex-wrap font-medium text-[18px] mb-6">
            <div class="text-green mr-2">N° de ticket:</div>
            <span>N° {{ selectedTask?.uuid.split("-")[4].toUpperCase() }}</span>
          </div>
          <div>
            <input
              type="text"
              formControlName="description"
              *ngIf="!selectedTask?.description && isSuperAdmin"
              placeholder="Ajouter une description"
              class="w-full rounded-[28px] text-sm border-[#DBDBDB] border-[3px] p-3"
            />
            <p *ngIf="selectedTask?.description">
              Description: {{ selectedTask?.description }}
            </p>
          </div>

          <div class="green-separator" *ngIf="isSuperAdmin || loggedUser.id == selectedTask?.assigned_user?.id">
            <div [formGroup]="messageForm">
              <label
                for="about"
                class="block text-sm font-medium text-gray-700"
              >
                Commentaire
              </label>
              <div class="mt-3 grid grid-cols-6 gap-4">
                <textarea
                  id="about"
                  name="about"
                  rows="3"
                  class="col-start-1 col-end-7 p-3 mb-5 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border border-gray-300 rounded-md"
                  placeholder="Tapez votre commentaire"
                  formControlName="message"
                ></textarea>
                <button
                  type="button"
                  class="mb-5 col-end-7 inline-block px-8 py-2.5 bg-green-600 text-white font-medium text-xs leading-tight uppercase shadow-md disabled:opacity-25 hover:bg-green-700 hover:shadow-lg focus:bg-green-700 focus:shadow-lg focus:outline-none focus:ring-0 active:bg-green-800 active:shadow-lg transition duration-150 ease-in-out rounded-[28px]"
                  (click)="addMessage()"
                >
                  Ajouter
                </button>
              </div>
            </div>
            <div class="comment overflow-x-auto">
              <div *ngFor="let message of selectedTask?.messages">
                <div class="flex items-center">
                  <div
                    [class]="
                      'w-1/6 flex ' +
                      (loggedUser.id != message?.user?.id
                        ? 'justify-end order-last'
                        : '')
                    "
                  >
                    <b>{{ message?.user?.name }}</b>
                  </div>
                  <div
                    class="w-5/6 block p-6 bg-white rounded-[28px] border border-gray-200 shadow-md hover:bg-gray-100 dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700"
                  >
                    {{ message?.message }}
                  </div>
                </div>
                <div
                  [class]="
                    'mt-2 mb-2 flex ' +
                    (loggedUser.id != message?.user?.id
                      ? 'justify-start'
                      : 'justify-end')
                  "
                >
                  <span>{{
                    message.created_at | date: "dd/MM/y HH:mm" | if_null
                  }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="flex flex-col items-left gap-4 pl-4">
        <div class="mb-4 font-semibold text-green text-[18px]">Statut</div>
        <form
          [formGroup]="taskForm"
          (ngSubmit)="onSubmit()"
          class="border-b-2 border-t-green-500"
        >
          <mat-form-field
            *ngIf="selectedTask.assigned_user"
            appearance="fill"
            class="w-[100%] mb-2"
          >
            <mat-label>Statut</mat-label>
            <mat-select formControlName="status">
              <mat-option value="IN_PROGRESS"
                >En Cours</mat-option
              >
              <mat-option value="UNSOLVED"
                >Non Résolue</mat-option
              >
              <mat-option value="DONE">Résolue</mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field
            *ngIf="isSuperAdmin"
            appearance="fill"
            class="w-[100%] mb-2"
          >
            <mat-label>Comptes</mat-label>
            <mat-select formControlName="assigned_user">
              <mat-option
                *ngFor="let item of accounts$ | async"
                [value]="item.id"
              >
                <ng-container *ngIf="item.id != loggedUser.id">
                  {{
                    item.name +
                      " | Direction " +
                      item.email.split("@")[0].split("-")[1]
                  }}
                </ng-container>
                <ng-container *ngIf="item.id == loggedUser.id">
                  Moi | Direction
                  {{ item.email.split("@")[0].split("-")[1] }}
                </ng-container>
              </mat-option>
            </mat-select>
          </mat-form-field>

          <button
            *ngIf="isSuperAdmin"
            type="submit"
            class="w-[100%] inline-block px-8 py-2.5 bg-[#000000] font-semibold shadow-lg hover:bg-[#000000] focus:bg-[#000000] active:bg-[#000000] active:shadow-lg transition duration-150 ease-in-out rounded-[28px] text-[#fff] mb-5"
          >
            Transférer
          </button>
          <button
            *ngIf="!isSuperAdmin"
            type="submit"
            class="w-[100%] inline-block px-8 py-2.5 bg-[#000000] font-semibold shadow-lg hover:bg-[#000000] focus:bg-[#000000] active:bg-[#000000] active:shadow-lg transition duration-150 ease-in-out rounded-[28px] text-[#fff] mb-5"
          >
            {{ selectedTask?.status === "OPEN" && !selectedTask.assigned_user ? "Je m'assigner le ticket" : "Transférer" }}
          </button>

          <button
            *ngIf="selectedTask?.status != 'OPEN'"
            (click)="resetTask()"
            [type]="'button'"
            [ngClass]="
              'mb-5 bg-[#0C8040] text-[#fff] border-[#0C8040] rounded-[28px] shadow-[0px_3px_6px_#00000029] w-[100%] py-2.5 px-8 font-semibold '
            "
          >
            Reinitialiser le ticket
          </button>
        </form>
        <div class="mb-2 font-semibold text-green text-[18px]">Détails:</div>
        <p>
          <strong class="pr-2">Statut actuel:</strong> {{ statusMapper[selectedTask?.status]['name'] }}
        </p>
        <p>
          <strong class="pr-2">Assigné à:</strong>
          {{ selectedTask?.assigned_user?.name }}
        </p>
        <p><strong class="pr-2">Créé le:</strong> {{ selectedTask?.created_at | date: 'dd/MM/yyyy' }}</p>
        <p>
          <strong class="pr-2">Dernière mise à jour:</strong>
          {{ selectedTask?.updated_at }}
        </p>

      </div>
    </div>
  </mat-dialog-content>
</div>
